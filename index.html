<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>T-Shirt Design Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .editor-container {
            display: flex;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .canvas-container {
            position: relative;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 0;
        }
        #design-canvas {
            border: 1px solid #ddd;
            border-radius: 10px;
            cursor: crosshair;
            width: 100%;
            height: auto;
            max-width: 600px;
            max-height: 600px;
        }
        .controls {
            width: 300px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        .control-group {
            margin-bottom: 20px;
        }
        .control-group h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .color-btn {
            width: 40px;
            height: 40px;
            border: 3px solid #000;
            border-radius: 50%;
            margin: 5px;
            cursor: pointer;
            outline: none;
            transition: all 0.2s ease;
        }
        .color-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            width: 100%;
            box-sizing: border-box;
        }
        .btn:hover {
            background: #0056b3;
        }
        .design-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
        }
        .design-item:hover {
            background: #f8f9fa;
        }
        .design-item.selected {
            border-color: #007bff;
            background: #e7f3ff;
        }
        .slider-container {
            margin: 10px 0;
        }
        .slider-container label {
            display: block;
            margin-bottom: 5px;
        }
        .slider-container input[type="range"] {
            width: 100%;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .editor-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .controls {
                width: 100%;
                order: -1;
            }
            
            #design-canvas {
                max-width: 100%;
                max-height: 400px;
            }
            
            .color-btn {
                width: 35px;
                height: 35px;
                margin: 3px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 16px;
            }
            
            .control-group {
                margin-bottom: 15px;
            }
            
            .control-group h3 {
                font-size: 16px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .controls {
                padding: 15px;
            }
            
            #design-canvas {
                max-height: 300px;
            }
            
            .color-btn {
                width: 30px;
                height: 30px;
                margin: 2px;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .control-group h3 {
                font-size: 14px;
            }
        }
        
        /* Tablet adjustments */
        @media (min-width: 769px) and (max-width: 1024px) {
            .editor-container {
                gap: 15px;
            }
            
            .controls {
                width: 250px;
            }
            
            #design-canvas {
                max-width: 500px;
                max-height: 500px;
            }
        }
        
        /* Large screen optimizations */
        @media (min-width: 1200px) {
            .editor-container {
                max-width: 1400px;
            }
            
            #design-canvas {
                max-width: 700px;
                max-height: 700px;
            }
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <div class="canvas-container">
            <canvas id="design-canvas" width="600" height="600"></canvas>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <h3>T-Shirt Color</h3>
                <button class="color-btn" style="background:white" onclick="changeTshirtColor('white')"></button>
                <button class="color-btn" style="background:red" onclick="changeTshirtColor('red')"></button>
                <button class="color-btn" style="background:blue" onclick="changeTshirtColor('blue')"></button>
                <button class="color-btn" style="background:green" onclick="changeTshirtColor('green')"></button>
                <button class="color-btn" style="background:black" onclick="changeTshirtColor('black')"></button>
                <button class="color-btn" style="background:yellow" onclick="changeTshirtColor('yellow')"></button>
                <button class="color-btn" style="background:pink" onclick="changeTshirtColor('pink')"></button>
            </div>
            
            <div class="control-group">
                <h3>Add Design</h3>
                <input type="file" id="design-upload" accept="image/*" style="display: none;">
                <button class="btn" onclick="document.getElementById('design-upload').click()">
                    Upload Image
                </button>
            </div>
            
            <div class="control-group">
                <h3>Designs</h3>
                <div id="designs-list"></div>
            </div>
            
            <div class="control-group">
                <h3>Selected Design</h3>
                <div id="design-controls" style="display: none;">
                    <div class="slider-container">
                        <label>Size: <span id="size-value">100%</span></label>
                        <input type="range" id="size-slider" min="0" max="200" value="100">
                    </div>
                    <div class="slider-container">
                        <label>Rotation: <span id="rotation-value">0°</span></label>
                        <input type="range" id="rotation-slider" min="0" max="360" value="0">
                    </div>
                    <button class="btn" onclick="deleteSelectedDesign()">Delete Design</button>
                </div>
            </div>
            
            <div class="control-group">
                <h3>Save Options</h3>
                <!-- <div style="margin-bottom: 10px;">
                    <label>
                        <input type="checkbox" id="transparent-bg" checked> 
                        Save with transparent background
                    </label>
                </div> -->
                <button class="btn" onclick="saveDesign()" style="background: #28a745;">
                    Save Design
                </button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('design-canvas');
        const ctx = canvas.getContext('2d');
        const tshirtImg = new Image();
        
        // This is crucial for preventing canvas errors on deployed servers
        tshirtImg.crossOrigin = "Anonymous";

        tshirtImg.onerror = () => {
            console.error('Failed to load "tshirt.png".');
            alert('ERROR: Could not load the t-shirt image. Make sure the file is named "tshirt.png" (no hyphen) and is in your project root.');
        };

        tshirtImg.onload = () => {
            console.log('Real "tshirt.png" image successfully loaded.');
            // Initialize the application now that we have the image
            setupCanvasQuality();
        };

        // This path should work on Vercel if "tshirt.png" is in the root directory
        tshirtImg.src = '/tshirt.png';

        let designs = [];
        let selectedDesign = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let currentTshirtColor = 'white';
        
        // Set up canvas for better image quality
        function setupCanvasQuality() {
            // Enable image smoothing for better quality
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            
            // Set up high DPI support for retina displays
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            
            // Set the actual size in memory (scaled up for high DPI)
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            
            // Scale the drawing context so everything draws at the correct size
            ctx.scale(dpr, dpr);
            
            // Set the CSS size back to the original size
            canvas.style.width = `${rect.width}px`;
            canvas.style.height = `${rect.height}px`;
            
            // Redraw after setup
            redrawCanvas();
        }
        
        // Handle window resize
        function handleResize() {
            if (tshirtImg.complete) {
                setupCanvasQuality();
            }
        }
        
        window.addEventListener('resize', handleResize);
        
        // Canvas event listeners
        canvas.addEventListener('mousedown', onMouseDown);
        canvas.addEventListener('mousemove', onMouseMove);
        canvas.addEventListener('mouseup', onMouseUp);
        
        // File upload
        document.getElementById('design-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        addDesign(img, 300, 300, 0);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Control sliders
        document.getElementById('size-slider').addEventListener('input', function(e) {
            if (selectedDesign) {
                selectedDesign.scale = e.target.value / 100;
                document.getElementById('size-value').textContent = e.target.value + '%';
                redrawCanvas();
            }
        });
        
        document.getElementById('rotation-slider').addEventListener('input', function(e) {
            if (selectedDesign) {
                selectedDesign.rotation = e.target.value * Math.PI / 180;
                document.getElementById('rotation-value').textContent = e.target.value + '°';
                redrawCanvas();
            }
        });
        
        function addDesign(img, x, y, rotation) {
            // Create a high-quality version of the image
            createHighQualityImage(img).then(highQualityImg => {
                const design = {
                    img: highQualityImg,
                    originalImg: img, // Keep original for reference
                    x: x,
                    y: y,
                    rotation: rotation,
                    scale: 1,
                    id: Date.now()
                };
                designs.push(design);
                updateDesignsList();
                redrawCanvas();
            });
        }
        
        // Alternative approach: Use CSS transforms for better quality
        function createHighQualityImage(img) {
            return new Promise((resolve) => {
                // Create a temporary canvas to improve image quality
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                // Set high quality settings
                tempCtx.imageSmoothingEnabled = true;
                tempCtx.imageSmoothingQuality = 'high';
                
                // Use a larger size for better quality (3x for very high quality)
                const scale = 3; // Scale up for better quality
                tempCanvas.width = img.width * scale;
                tempCanvas.height = img.height * scale;
                
                // Draw the image at higher resolution
                tempCtx.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
                
                // Create a new image from the high-quality canvas
                const highQualityImg = new Image();
                highQualityImg.onload = () => resolve(highQualityImg);
                highQualityImg.src = tempCanvas.toDataURL('image/png', 1.0);
            });
        }
        
        function redrawCanvas() {
            if (!tshirtImg) {
                console.log('T-shirt image not ready yet, waiting...');
                return;
            }
            
            console.log('Redrawing canvas with t-shirt...');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw t-shirt with color using the same technique as the original code
            drawTshirtWithColor();
            
            // Draw designs
            designs.forEach(design => {
                ctx.save();
                ctx.translate(design.x, design.y);
                ctx.rotate(design.rotation);
                ctx.scale(design.scale, design.scale);
                ctx.drawImage(design.img, -design.img.width/2, -design.img.height/2);
                ctx.restore();
                
                // Draw selection border
                if (design === selectedDesign) {
                    ctx.strokeStyle = '#007bff';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(design.x - design.img.width/2 * design.scale, 
                                 design.y - design.img.height/2 * design.scale,
                                 design.img.width * design.scale, 
                                 design.img.height * design.scale);
                }
            });
        }
        
        function drawTshirtWithColor() {
            // First draw the original t-shirt
            ctx.drawImage(tshirtImg, 0, 0, canvas.width, canvas.height);

            // Set blend mode to multiply for realistic color overlay
            ctx.globalCompositeOperation = 'multiply';
            ctx.fillStyle = currentTshirtColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Restore blend mode to default
            ctx.globalCompositeOperation = 'destination-in';
            ctx.drawImage(tshirtImg, 0, 0, canvas.width, canvas.height);

            // Reset blend mode for future operations
            ctx.globalCompositeOperation = 'source-over';
        }
        
        function onMouseDown(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Check if clicking on a design
            for (let i = designs.length - 1; i >= 0; i--) {
                const design = designs[i];
                const designX = design.x;
                const designY = design.y;
                const designWidth = design.img.width * design.scale;
                const designHeight = design.img.height * design.scale;
                
                if (x >= designX - designWidth/2 && x <= designX + designWidth/2 &&
                    y >= designY - designHeight/2 && y <= designY + designHeight/2) {
                    selectedDesign = design;
                    isDragging = true;
                    dragOffset.x = x - designX;
                    dragOffset.y = y - designY;
                    updateDesignsList();
                    updateDesignControls();
                    redrawCanvas();
                    return;
                }
            }
            
            selectedDesign = null;
            updateDesignsList();
            updateDesignControls();
            redrawCanvas();
        }
        
        function onMouseMove(e) {
            if (isDragging && selectedDesign) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                selectedDesign.x = x - dragOffset.x;
                selectedDesign.y = y - dragOffset.y;
                redrawCanvas();
            }
        }
        
        function onMouseUp() {
            isDragging = false;
        }
        
        function updateDesignsList() {
            const list = document.getElementById('designs-list');
            list.innerHTML = '';
            
            designs.forEach((design, index) => {
                const item = document.createElement('div');
                item.className = 'design-item' + (design === selectedDesign ? ' selected' : '');
                item.textContent = `Design ${index + 1}`;
                item.onclick = () => {
                    selectedDesign = design;
                    updateDesignsList();
                    updateDesignControls();
                    redrawCanvas();
                };
                list.appendChild(item);
            });
        }
        
        function updateDesignControls() {
            const controls = document.getElementById('design-controls');
            if (selectedDesign) {
                controls.style.display = 'block';
                document.getElementById('size-slider').value = selectedDesign.scale * 100;
                document.getElementById('rotation-slider').value = selectedDesign.rotation * 180 / Math.PI;
                document.getElementById('size-value').textContent = Math.round(selectedDesign.scale * 100) + '%';
                document.getElementById('rotation-value').textContent = Math.round(selectedDesign.rotation * 180 / Math.PI) + '°';
            } else {
                controls.style.display = 'none';
            }
        }
        
        function deleteSelectedDesign() {
            if (selectedDesign) {
                designs = designs.filter(d => d !== selectedDesign);
                selectedDesign = null;
                updateDesignsList();
                updateDesignControls();
                redrawCanvas();
            }
        }
        
        function changeTshirtColor(color) {
            currentTshirtColor = color;
            redrawCanvas();
        }
        
        function saveDesign() {
            try {
                // Check if canvas is accessible
                if (!canvas || !ctx) {
                    throw new Error('Canvas not available');
                }
                
                // Create a temporary canvas for saving
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                const tempCtx = tempCanvas.getContext('2d');
                
                if (!tempCtx) {
                    throw new Error('Could not create temporary canvas context');
                }
                
                // Check if user wants transparent background
                const transparentBg = document.getElementById('transparent-bg').checked;
                
                if (transparentBg) {
                    // Clear with transparent background
                    tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
                    
                    // Draw t-shirt with color but preserve transparency
                    drawTshirtWithColorOnCanvas(tempCtx);
                } else {
                    // Fill with t-shirt color as background
                    tempCtx.fillStyle = currentTshirtColor;
                    tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                    
                    // Draw t-shirt with color
                    drawTshirtWithColorOnCanvas(tempCtx);
                }
                
                // Draw designs
                designs.forEach(design => {
                    tempCtx.save();
                    tempCtx.translate(design.x, design.y);
                    tempCtx.rotate(design.rotation);
                    tempCtx.scale(design.scale, design.scale);
                    tempCtx.drawImage(design.img, -design.img.width/2, -design.img.height/2);
                    tempCtx.restore();
                });
                
                // Try to get data URL with transparency
                let dataURL;
                try {
                    dataURL = tempCanvas.toDataURL('image/png', 1.0);
                } catch (e) {
                    // Fallback: try without specifying format
                    dataURL = tempCanvas.toDataURL();
                }
                
                if (!dataURL || dataURL === 'data:,') {
                    throw new Error('Could not generate image data');
                }
                
                // Create download link
                const link = document.createElement('a');
                const filename = transparentBg ? 'tshirt-design-transparent.png' : 'tshirt-design.png';
                link.download = filename;
                link.href = dataURL;
                
                // Add to DOM temporarily
                document.body.appendChild(link);
                
                // Trigger download
                link.click();
                
                // Clean up
                setTimeout(() => {
                    document.body.removeChild(link);
                }, 100);
                
                const message = transparentBg 
                    ? 'T-shirt design saved with transparent background!' 
                    : 'T-shirt design saved with background color!';
                alert(message + ' Check your downloads folder.');
                
            } catch (error) {
                console.error('Error saving design:', error);
                
                // Try alternative save method
                try {
                    console.log('Trying alternative save method...');
                    const dataURL = canvas.toDataURL();
                    const link = document.createElement('a');
                    link.download = 'tshirt-design.png';
                    link.href = dataURL;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    alert('Design saved using alternative method!');
                } catch (altError) {
                    console.error('Alternative save method also failed:', altError);
                    alert('Error saving design. Please try:\n1. Right-click on the canvas and "Save image as"\n2. Take a screenshot\n3. Check browser console for details');
                }
            }
        }
        
        function drawTshirtWithColorOnCanvas(targetCtx) {
            // First draw the original t-shirt
            targetCtx.drawImage(tshirtImg, 0, 0, canvas.width, canvas.height);

            // Set blend mode to multiply for realistic color overlay
            targetCtx.globalCompositeOperation = 'multiply';
            targetCtx.fillStyle = currentTshirtColor;
            targetCtx.fillRect(0, 0, canvas.width, canvas.height);

            // Restore blend mode to default
            targetCtx.globalCompositeOperation = 'destination-in';
            targetCtx.drawImage(tshirtImg, 0, 0, canvas.width, canvas.height);

            // Reset blend mode for future operations
            targetCtx.globalCompositeOperation = 'source-over';
        }
    </script>
</body>
</html>
